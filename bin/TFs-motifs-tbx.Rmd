---
title: "Genes that are regulated by anc-1 and have a T-box transcription factor binding motif"
output: html_document
---

## Load previously generated data analyses
These are the data obtained by my running motif enrichment of all known *C. elegnas* motifs.
```{r}
load("experiments/2018-09-02-TFs-motifs/data/TFs-motif-enrichment-results.rdata")
```

Generate report tables of motif scores in promoters of *anc-1* regulated genes.
```{r}
report <- lapply(res, groupReport,by.top.motifs=FALSE) # Report of all enrichment scores.
```

Extract T-box transcription factors scores.
```{r}
report$N2.up[grep("tbx-",report$N2.up$id),] 
report$AM.up[grep("tbx-",report$AM.up$id),]
report$N2.dn[grep("tbx-",report$N2.dn$id),]
report$AM.dn[grep("tbx-",report$AM.dn$id),]
```

# Plotting a heatmap of the expression of all modified genes fold-change p-value for each 

# Plotting a heatmap of the p-value for each 


## Create p-values matrix
Obtain the p-values of motifs per sequence.
* rows correspond to the different input sequences and the columns correspond to motifs.
* **sequence.nobg** contains the raw affinity scores.
* **sequence.bg** contains the corresponding P-values.
```{r}
pvals.mat <- lapply(res, function(x) x$sequence.bg)
```

Define the names of the t-box proteins to be used as the x-axis label.
```{r}
colnames(pvals.mat) <- c("TBX-33","TBX-38","TBX-39","TBX-40","TBX-43")
```



Change the gene IDs to common gene names
```{r}
rownames(pvals.mat) <-  mRNA.ids$external_gene_name[which(mRNA.ids$ensembl_gene_id %in% rownames(pvals.mat))]
```

## Change p-value to boolean, which are TRUE if statistically significant and filter-out genes w/ no motif
```{r}


pvals.mat.sig <- (pvals.mat < 0.05) * 1
pvals.mat.sig <- pvals.mat.sig[rowSums(pvals.mat.sig) > 0,]
round(sum(pvals.mat.sig[,1]) / nrow(pvals.mat) * 100)
round(sum(pvals.mat.sig[,2]) / nrow(pvals.mat) * 100)
round(sum(pvals.mat.sig[,3]) / nrow(pvals.mat) * 100)
round(sum(pvals.mat.sig[,4]) / nrow(pvals.mat) * 100)
round(sum(pvals.mat.sig[,5]) / nrow(pvals.mat) * 100)

```

## (for grant propoal) 
```{r}
row_dend = hclust(dist(pval.mat.sig)) # row clustering
col_dend = hclust(dist(t(pval.mat.sig))) # column clustering

pdf("tbx_heatmap_up_grant.pdf",width=4,height=10)
Heatmap(pval.mat.sig, 
        name = "Motif enrichment p-value", #title of legend
        column_title = "T-BOX motif enrichment", 
        row_title = "Genes upregulated by anc-1 RNAi",
        column_names_side = "top",
        row_names_gp = gpar(fontsize = 7), # Text size for row names
        column_names_gp = gpar(fontsize = 7), # Text size for column names
        cluster_rows = color_branches(row_dend, k = 2),
        #km = 8 ,# To split the dendrogram using k-means, divide into 4 groups. Must set.seed
        cluster_columns = color_branches(col_dend, k = 3),
        col = mycols)

dev.off()

dev.print(png, 'filename.png')
dev.copy2pdf('filename.pdf',out.type = "pdf")
dev.off()

```




## Create p-values data-frame
Add 'gene name' variable to p-value dataframe, and make long data
```{r}
pvals.df.long <- pvals.mat.sig %>%
  as_tibble(rownames = "external_gene_name") %>% 
  gather(TF.motifs, p.value, -external_gene_name)
```

## Is there a correlation between any two motifs?
```{r}
cor <- cor(pvals.mat, method = "pearson")
if (!require(Hmisc)) {install.packages("Hmisc"); library(Hmisc)}
cor2 <- rcorr(pvals.mat)
```

The function rcorr() [in Hmisc package] can be used to compute the significance levels for pearson and spearman correlations. It returns both the correlation coefficients and the p-value of the correlation for all possible pairs of columns in the data table.
```{r}
if (!require(corrplot)) {install.packages("corrplot"); library(corrplot)}

corrplot(cor, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```

## Plot heatmap of p-values ver2
based on (Heatmap - Static and Interactive: Absolute Guide
)[http://www.sthda.com/english/articles/28-hierarchical-clustering-essentials/93-heatmap-static-and-interactive-absolute-guide/]
```{r}

if (!require(dendextend)) {install.packages("dendextend"); library("dendextend")}
               
row_dend = hclust(dist(pvals.mat.sig)) # row clustering
col_dend = hclust(dist(t(pvals.mat.sig))) # column clustering

if (!require(ComplexHeatmap)) {biocLite("ComplexHeatmap"); library("ComplexHeatmap")}
Heatmap(pvals.mat.sig,
        name = "Motif presence (p-value < 0.05)", # title of legend
        row_title = "Genes downregulated by anc-1 RNAi",
        column_names_side = "top",
        row_names_gp = gpar(fontsize = 6), # Text size for row names
        cluster_rows = color_branches(row_dend, k = 8),
        cluster_columns = color_branches(col_dend, k = 3),
        col = c("grey","blue")) 

require("pheatmap")
pheatmap(pvals.mat.sig, 
         cutree_rows = 8, 
         color = c("white","red"),
         cellwidth = 5,
         cellheight = 5)


```
