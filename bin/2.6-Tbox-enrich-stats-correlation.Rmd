---
title: "T-box transcription factors heatmap"
author: "Amir Levine"
date: "2018-12-31"
output: md_document
---

## Load packages and datasets.
```{r}
# Data pre-processing
if (!require(tidyverse)) {install.packages("tidyverse"); library(tidyverse)}
# Plot heatmap
if (!require(pheatmap)) {biocLite("pheatmap"); library("pheatmap")}
if (!require(gplots)) {biocLite("gplots"); library("gplots")}
# Heatmap colors
if (!require(viridis)) {biocLite("viridis"); library("viridis")}

load("data/geneExpression.rdata")
# PWMEnrich object of Tbox transcrption factors motifs enrichement in the promoters of anc-1 RNAi regulateed genes.
load("experiments/2018-07-11-tbx-motifs/data/Tbox-anc1-reg-enriched.Rdata")
```

## Data Pre-Processing
Focus on the genes that are down-regulated by *anc-1*, as those are enriched for TBX motifs.
```{r}
# Separate AM140 and N2 data. Data that may be relevant for clustering.
AM <- BOTH %>% select(Gene_stable_ID,Gene_name,strain,log2FoldChange,padj) %>%
  filter(strain == "AM140")
NT <- BOTH %>% select(Gene_stable_ID,Gene_name,strain,log2FoldChange,padj) %>% 
  filter(strain == "N2")
AM.NT <- full_join(NT,AM,by = c('Gene_stable_ID','Gene_name'), suffix = c(".N2",".AM140"))

# Create p-values matrix. Obtain the *p*-values of motifs per sequence. Rows correspond to the different input sequences and the columns correspond to motifs. `sequence.nobg` contains the raw affinity scores.`sequence.bg` contains the corresponding P-values.
tbx.pv.dn.mat <- res.dn$sequence.bg

# Set the gene names to serve as the background list for later annotation analysis
bg <- rownames(tbx.pv.dn.mat)

# Rename the column names to be the T-box protein names.
colnames(tbx.pv.dn.mat) <- c("TBX-33","TBX-38","TBX-39","TBX-40","TBX-43")

# Covert the p-values matrix to a tibble to merge with the previous data-object.
tbx.pv.dn.tbl <- as.tibble(tbx.pv.dn.mat) %>%
  mutate(Gene_stable_ID = rownames((tbx.pv.dn.mat)))

# Combine the TBX binding-sties p-values with the previous data-object.
AM.NT <- inner_join(AM.NT, tbx.pv.dn.tbl, by='Gene_stable_ID')
```

# Convert the dataframes back to matrices of TBX p-values
```{r}
# TBX binding motifs Matrix
tbx.pv.dn.mat <- AM.NT %>% 
  select("TBX-33","TBX-38","TBX-39","TBX-40","TBX-43") %>%
  as.matrix()
rownames(tbx.pv.dn.mat) <- AM.NT$Gene_name
```

# Convert the TBX binding-sites p-values matrix to binary
```{r}
# Change p-value to boolean. TRUE is statistically significant (*p*-value < 0.05).
tbx.bool.dn.mat <- (tbx.pv.dn.mat < 0.01)

# Index of amount of T-box transcription factors binding motif
TBXTFBM <- rowSums(tbx.bool.dn.mat*1) 

# Filter genes w/o T-box transcription factors binding motifs from the p-values matrix
tbx.pv.dn.mat <- tbx.pv.dn.mat[TBXTFBM != 0,]

# Filter genes w/o T-box transcription factors binding motifs from the Boolean matrix
tbx.bool.dn.mat <- tbx.bool.dn.mat[TBXTFBM != 0,]
```

## Plotting Heatmaps
Setting the path for saving the heatmaps
```{r}
path = "experiments/2018-12-30-tbx-heatmap/results/"
```

Annotations for matrix of binding sites presence
```{r}
tbtf = "T-box transcription factor"
tf = "Transcription factor"
chrm = "Chromatin-related"
prts = "Proteostasis-related"
fb = "F-box protein-related"

Function <- c(tbtf, tf, chrm, prts, prts, tf, tf, tbtf, "", "",
              tf, "", "", "", "", "", "", tf, "", "",
              tf, fb, "", "", chrm, tf, "", "", fb, "", 
              tbtf, "", "", "", fb, "", "", "", "", fb,
              chrm, "", prts, tf, "", "", ""
)
# Decided not to include the expression changes
#FC.N2 <- AM.NT$log2FoldChange.N2[AM.NT$Gene_name %in% rownames(tbx.bool.dn.mat)]
#FC.AM <- AM.NT$log2FoldChange.AM140[AM.NT$Gene_name %in% rownames(tbx.bool.dn.mat)]

ann <- data.frame("Function" = Function
                  #"Fold-Change (WT)" = FC.N2
                  #"Fold-Change (polyQ35)" = FC.AM
)
rownames(ann) <- rownames(tbx.bool.dn.mat)

# Fold-change levels of the selected genes

```

Heatmap of T-box transcription factors binding sites binary presence
```{r}
row_dend <- hclust(dist(tbx.bool.dn.mat, method = "binary"),
                   method = "complete") # row clustering
col_dend <- hclust(dist(t(tbx.bool.dn.mat), method = "binary"),
                   method = "complete") # column clustering

pheatmap(tbx.bool.dn.mat*1,
         
         # Colors of the cells
         color = c("white","black"),
         border_color = "grey",
         
         # dimensions of the cells
         cellwidth = 7,
         cellheight = 7,
         
         # Clustering
         cluster_rows = row_dend,
         cluster_cols = col_dend,
         cutree_rows = 9,
         
         # dendogram graphics
         treeheight_row = 5,
         treeheight_col = 5,
         
         # Remove the legend
         legend = FALSE,
         
         # Fonts
         fontsize = 7,
         
         # Gene annotations
         annotation_row = ann,
         drop_levels = TRUE,

         # Export figure
         filename = paste0(path,"2018-12-31-hm",".pdf")
         )
```

Heatmap of T-box transcription factors binding sites p-values
```{r}
cairo_pdf(paste0(path,"2018-12-30-hm",".pdf"),
    width = 2,
    height = 2.5,
    pointsize = 4)

# Plot Heatmap
heatmap.2(-log10(tbx.pv.dn.mat),
          # Define the color range
          breaks = c(0,1,2,3,4),
          col = magma(4),
          
          # Hierarch clustering rows 1-Pearson correlation distance with complete linkage
          distfun = function(x) as.dist(1-cor(t(x))), 
          hclustfun = function(x) hclust(x, method="complete"),
          
          # Remove the cyan trace
          trace = "none",
          density.info = "none",
          
          # Separate the columns
          colsep = c(2,3),
          
          # Column labels formatting
          srtCol = 45,
          offsetCol = 0,
          
          # Color Key
          keysize = 1.5,
          key.title = "-log10(p-value)"
          )

dev.off()
```


```
> sessionInfo()
R version 3.5.1 (2018-07-02)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows >= 8 x64 (build 9200)

Matrix products: default

locale:
[1] LC_COLLATE=English_Israel.1252  LC_CTYPE=English_Israel.1252    LC_MONETARY=English_Israel.1252
[4] LC_NUMERIC=C                    LC_TIME=English_Israel.1252    

attached base packages:
 [1] stats4    parallel  grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] biomaRt_2.38.0        BiocInstaller_1.32.1  pheatmap_1.0.10       gplots_3.0.1          RColorBrewer_1.1-2   
 [6] psych_1.8.10          corrplot_0.84         Hmisc_4.1-1           Formula_1.2-3         survival_2.42-3      
[11] lattice_0.20-35       PWMEnrich_4.18.0      Biostrings_2.50.0     XVector_0.22.0        IRanges_2.16.0       
[16] S4Vectors_0.20.0      BiocGenerics_0.28.0   bindrcpp_0.2.2        viridis_0.5.1         viridisLite_0.3.0    
[21] ComplexHeatmap_1.20.0 dendextend_1.9.0      forcats_0.3.0         stringr_1.3.1         dplyr_0.7.7          
[26] purrr_0.2.5           readr_1.1.1           tidyr_0.8.2           tibble_1.4.2          ggplot2_3.1.0        
[31] tidyverse_1.2.1      

loaded via a namespace (and not attached):
 [1] colorspace_1.3-2     rjson_0.2.20         class_7.3-14         modeltools_0.2-22    mclust_5.4.1        
 [6] evd_2.3-3            circlize_0.4.4       htmlTable_1.12       GlobalOptions_0.1.0  base64enc_0.1-3     
[11] rstudioapi_0.8       bit64_0.9-7          flexmix_2.3-14       AnnotationDbi_1.44.0 fansi_0.4.0         
[16] mvtnorm_1.0-8        lubridate_1.7.4      xml2_1.2.0           splines_3.5.1        mnormt_1.5-5        
[21] robustbase_0.93-3    knitr_1.20           jsonlite_1.5         seqLogo_1.48.0       broom_0.5.0         
[26] cluster_2.0.7-1      kernlab_0.9-27       BiocManager_1.30.3   compiler_3.5.1       httr_1.3.1          
[31] backports_1.1.2      assertthat_0.2.0     Matrix_1.2-14        lazyeval_0.2.1       cli_1.0.1           
[36] prettyunits_1.0.2    acepack_1.4.1        htmltools_0.3.6      tools_3.5.1          gtable_0.2.0        
[41] glue_1.3.0           Rcpp_0.12.19         Biobase_2.42.0       cellranger_1.1.0     trimcluster_0.1-2.1 
[46] gdata_2.18.0         nlme_3.1-137         fpc_2.1-11.1         rvest_0.3.2          gtools_3.8.1        
[51] XML_3.98-1.16        DEoptimR_1.0-8       zlibbioc_1.28.0      MASS_7.3-50          scales_1.0.0        
[56] hms_0.4.2            yaml_2.2.0           memoise_1.1.0        gridExtra_2.3        rpart_4.1-13        
[61] RSQLite_2.1.1        latticeExtra_0.6-28  stringi_1.2.4        checkmate_1.8.5      caTools_1.17.1.1    
[66] shape_1.4.4          rlang_0.3.0.1        pkgconfig_2.0.2      prabclus_2.2-6       bitops_1.0-6        
[71] bindr_0.1.1          htmlwidgets_1.3      bit_1.1-14           tidyselect_0.2.5     plyr_1.8.4          
[76] magrittr_1.5         R6_2.3.0             DBI_1.0.0            pillar_1.3.0         haven_1.1.2         
[81] whisker_0.3-2        foreign_0.8-70       withr_2.1.2          RCurl_1.95-4.11      nnet_7.3-12         
[86] modelr_0.1.2         crayon_1.3.4         KernSmooth_2.23-15   utf8_1.1.4           progress_1.2.0      
[91] GetoptLong_0.1.7     readxl_1.1.0         data.table_1.11.8    blob_1.1.1           digest_0.6.18       
[96] diptest_0.75-7       munsell_0.5.0       
```