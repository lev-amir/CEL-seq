---
title: "Check for an enrichment of C. elegans transcription factors motifs in the promoter of anc-1 targets"
output: html_document
---

## Load bioconductor and packages
```{r}
source("https://bioconductor.org/biocLite.R")
if (!require(tidyverse)) {install.packages("tidyverse"); library(tidyverse)}
if (!require(PWMEnrich)) {install.packages("PWMEnrich"); library(PWMEnrich)}
install.packages("VennDiagram") ; library(VennDiagram)
```

# Gene-lists and Sequences
Load data from upstream analyses.
```{r}
# Load CEL-seq gene lists
load("data/geneExpression.rdata")
# Load promoters of C. elegans genes. Data generated by "Celegans-promoters.R"
load("data/Celegans-promoters.rdata")
# Load the background PWMs applied to all sequences object, which is generated by "TFs-background.Rmd".
load("experiments/2018-09-02-TFs-motifs/data/background-celegans-TF.rdata")
```

# Motif enrichment scanning
Perform transcription factors enrichment analysis to sequences of interest -- the promoter sequences of all the genes that are significantly (p<0.1) regulated by *anc-1*, in both strains. A previous version of this analysis focused on the intersect of the two strains, with upregulated and downregulated genes analyzed separately.

Set all genes lists of interest.
```{r}
reg.genes <- list(N2.up = DEG$N2.up,
                  N2.dn = DEG$N2.dn,
                  AM.up = DEG$AM.up,
                  AM.dn = DEG$AM.dn)
```

Define function for motif enrichment analysis based on the bioconductor (PWMEnrich  package)[https://www.bioconductor.org/packages/release/bioc/html/PWMEnrich.html]
```{r}
me <- function(goi,mRNA.seqs.promoter,prs) {
  mRNA.seqs.promoter$CELseq.hits <- mRNA.seqs.promoter$ensembl_gene_id %in% goi
  return(motifEnrichment(prs[mRNA.seqs.promoter$CELseq.hits], bg.custom))
}
```

Apply function to each gene list and store results as a list file.
```{r}
useBigMemoryPWMEnrich(TRUE) # using large amount of memory
#registerCoresPWMEnrich(4) # Parallel execution Not supported in Windows

res <- lapply(reg.genes, me,mRNA.seqs.promoter,prs)

useBigMemoryPWMEnrich(FALSE) # disable using large amount of memory
#registerCoresPWMEnrich(NULL) # disable Parallel execution
```

It was a long run so save the generated object.
```{r}
save(res,file = "experiments/2018-09-02-TFs-motifs/data/TFs-motif-enrichment-results")
```

## Motif enrichment scanning to sampled random sequences as a control
Perform an analysis similar to the previous one, only with random sequences to serve as a negative control.

Check the regulated gene lists length to generate random lists, and generate lists.
```{r}
rand.len <- lapply(reg.genes,length)

rand.reg.genes <- list()

set.seed(sum(unlist(rand.len)))

for (trt in names(rand.len)) {
  rand.reg.genes[[trt]] <- sample(mRNA.seqs.promoter$ensembl_gene_id,
                                  rand.len[[trt]])
}
```

Apply motif enrichment analysis function to each gene list and store results as a list file.
```{r}
useBigMemoryPWMEnrich(TRUE) # using large amount of memory
#registerCoresPWMEnrich(4) # Parallel execution Not supported in Windows

rand.res <- lapply(rand.reg.genes,me,mRNA.seqs.promoter,prs)

useBigMemoryPWMEnrich(FALSE) # disable using large amount of memory
#registerCoresPWMEnrich(NULL) # disable Parallel execution
```

It was a long run so save the generated object.
```{r}
save(rand.res,file = "experiments/2018-09-02-TFs-motifs/data/TFs-motif-enrichment-results-random")
```

# EDA

## Load previously generated data analyses if necessary
```{r}
load("experiments/2018-09-02-TFs-motifs/data/TFs-motif-enrichment-results")
load("experiments/2018-09-02-TFs-motifs/data/TFs-motif-enrichment-results-random")
```

## Visualize p-values
Generate a report and extract p-values for motif pair.
```{r}
report <- lapply(res, groupReport,by.top.motifs=FALSE) # Report of all enrichment scores.
report.rand <- lapply(rand.res,groupReport,by.top.motifs=FALSE)

report.ps <- unlist(lapply(report, function(x) {x$p.value}))
report.rand.ps <- unlist(lapply(report.rand, function(x) {x$p.value}))
```

Plot pooled p-values for each motif, to check if there's a difference between true data and randomly sampled data.
```{r}
par(mfrow = c(1,2))

hist(report.ps,20)
hist(report.rand.ps,20)
```

Plot transcription factor motifs with statistically significantly (p-value < 0.05) enriched motifs. 
**Top motifs** indicates in what percentage of sequences was the corresponding motif among the 5% lowest p-value (out of all examined motifs p-values).
```{r}
# plot(report$N2.up[report$N2.up$p.value < 0.05], fontsize=7, id.fontsize=6)

x <- report

a <- x$N2.up[x$N2.up$p.value<0.05,]
b <- x$AM.up[x$AM.up$p.value<0.05,]
ab <- intersect(a$target,b$target)

c <- x$N2.dn[x$N2.dn$p.value<0.05,]
d <- x$AM.dn[x$AM.dn$p.value<0.05,]
cd <- intersect(c$target,d$target)

abcd <- intersect(ab,cd)
ab.only <- setdiff(ab,cd)
cd.only <- setdiff(cd,ab)
```

Which transcription factors are transcriptionally regulated by anc-1 and have an enrichemnt of motifs in the promoters of ANC-1 regulated genes?
```{r}
motif.ids <- report$N2.up$id # all motifs tested
deg.id <- BOTH %>% filter(Gene_stable_ID %in% DEG$UNION.reg) %>% pull(Gene_name) # all differentially regulated genes

motif.CELseq <- intersect(motif.ids,deg.id) # differentially regulated motifs tested TFs


motif.sig <- unique(c(a$target,b$target,c$target,d$target)) # significanlly regulated motifs that appear in any sample
motif.sig.deg <- intersect(motif.CELseq,motif.sig) # significanlly regulated motifs that appear in any sample and whose expression is differentialy regulated

motif.sig.up <- intersect(motif.CELseq,ab)
motif.sig.dn <- intersect(motif.CELseq,cd)
motif.sig.deg[ !( motif.sig.deg %in% c(motif.sig.up,motif.sig.dn) ) ]

```

Venn of transcription factors based on  
```{r}
# ---------------------------------------------------
venn.diagram(
  x = list("In upregulated promoters" = ab, "In downregulated promoter" = cd),
  filename = "experiments/2018-09-02-TFs-motifs/results/venn_TF_regulators.tiff",
  resolution = 300,
  imagetype = "tiff",
  main = "Transcription factor motifs",
  main.cex = 3,
  main.fontfamily = "sans",
  fill = c("red2", "green2"),
  cex = 2.5 ,# size of the areas’ labels
  fontfamily = "sans",# the fontfamily of the areas’ labels
  cat.cex = 3 ,#the size of the category names
  cat.pos = c(180+30,180-30),
  cat.dist = +0.04,
  cat.col = c("red2", "green2"),
  cat.fontfamily = "sans",
  print.mode = c("raw","percent"),
  sub = "Transcription factors with motifs enriched in anc-1 regulated genes' promoters",
  sub.cex = 1.5,
  sub.fontfamily = "sans"
)
```

Export transcription factors lists according to their motifs enrichment in upregulated / downregulated genes' promoters.
```{r}
write(ab.only,"experiments/2018-09-02-TFs-motifs/results/TF-motifs-in-up.txt")
write(cd.only,"experiments/2018-09-02-TFs-motifs/results/TF-motifs-in-dn.txt")
write(abcd,"experiments/2018-09-02-TFs-motifs/results/TF-motifs-in-up-dn.txt")
```
